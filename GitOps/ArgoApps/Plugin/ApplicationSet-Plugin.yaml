apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: plugin-pull-request-applicationset
  namespace: openshift-gitops
spec:
  generators:
    - plugin:
        configMapRef:
          name: pull-reqeust-plugin-config
        requeueAfterSeconds: 30
  template:
    metadata:
      name: "{{branch}}-{{project}}"
    spec:
      project: pull-request-plugin
      source:
        helm:
          valueFiles:
            - '{{projectName}}/develop/values-{{repoName}}.yaml'
          parameters:
            - name: "image.tag"
              value: '{{tag}}'
            - name: "global.namespace"
              value: '{{projectName}}-{{branch}}'
        repoURL: '{{repoURL}}/{{projectName}}/{{gitopsRepo}}.git'
        targetRevision: 'main'
        path: Application
      destination:
        server: https://kubernetes.default.svc
        namespace: pull-request
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true